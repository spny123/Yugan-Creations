<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudVault Pro - Your Personal Cloud Storage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3b82f6;
            --secondary-color: #1e40af;
            --background: #ffffff;
            --surface: #f8fafc;
            --surface-hover: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        [data-theme="dark"] {
            --primary-color: #60a5fa;
            --secondary-color: #3b82f6;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-card {
            background: var(--surface);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .input-group {
            margin: 1rem 0;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            background: var(--background);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .header {
            background: var(--surface);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: var(--surface-hover);
            border: none;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--primary-color);
            color: white;
        }

        .storage-info {
            background: var(--surface);
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .main-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 250px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.25rem;
        }

        .sidebar-item:hover, .sidebar-item.active {
            background: var(--primary-color);
            color: white;
        }

        .content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .breadcrumb-item {
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .breadcrumb-item:hover {
            color: var(--primary-color);
        }

        .toolbar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--surface);
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background: var(--surface-hover);
            transform: translateY(-2px);
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .file-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .file-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .file-card.selected {
            border-color: var(--primary-color);
            background: var(--surface-hover);
        }

        .file-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-color);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            color: white;
            font-size: 1.5rem;
        }

        .folder-icon {
            background: #f59e0b;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        .file-size {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .file-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            gap: 0.25rem;
        }

        .file-card:hover .file-actions {
            opacity: 1;
        }

        .action-btn {
            background: var(--surface-hover);
            border: none;
            padding: 0.25rem;
            border-radius: 0.25rem;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .search-bar {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--background);
            color: var(--text-primary);
        }

        .search-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .status-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transform: translateY(100px);
            transition: transform 0.3s ease;
        }

        .status-indicator.show {
            transform: translateY(0);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: 1rem;
            max-width: 80vw;
            max-height: 80vh;
            width: 90%;
            box-shadow: var(--shadow-lg);
            overflow-y: auto;
        }

        .modal-large {
            max-width: 95vw;
            max-height: 95vh;
        }

        .code-editor {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.4;
            resize: vertical;
            min-height: 300px;
            width: 100%;
            color: var(--text-primary);
        }

        .image-viewer {
            text-align: center;
            max-width: 100%;
        }

        .image-viewer img {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 0.5rem;
            box-shadow: var(--shadow);
        }

        .pdf-viewer {
            width: 100%;
            height: 70vh;
            border: none;
            border-radius: 0.5rem;
        }

        .bulk-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: var(--surface);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .storage-setting {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .storage-setting input {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            background: var(--background);
            color: var(--text-primary);
            width: 100px;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .content-area {
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .files-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .modal-content {
                max-width: 95vw;
                max-height: 95vh;
            }

            .setting-item {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
        }

        @media (max-width: 640px) {
            .sidebar {
                position: fixed;
                left: -250px;
                height: 100%;
                z-index: 200;
                transition: left 0.3s ease;
            }
            
            .sidebar.show {
                left: 0;
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="logo">?? CloudVault Pro</div>
            <p style="margin-bottom: 2rem; color: var(--text-secondary);">
                Secure cloud storage for all your files
            </p>
            <form id="loginForm">
                <div class="input-group">
                    <label for="password">Enter Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn">Access CloudVault</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app hidden" id="mainApp">
        <header class="header">
            <div class="header-left">
                <div class="logo">?? CloudVault Pro</div>
                <div class="search-bar">
                    <input type="text" placeholder="Search files..." id="searchInput">
                    <span class="search-icon">??</span>
                </div>
            </div>
            <div class="header-right">
                <div class="storage-info" id="storageInfo">
                    <strong>Storage:</strong> <span id="usedStorage">0 MB</span> / <span id="maxStorage">1000 GB</span> (<span id="totalStorage">1 TB</span>)
                </div>
                <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                    ??
                </button>
                <button class="theme-toggle" onclick="openSettings()" title="Settings">
                    ??
                </button>
                <button class="btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-item active" data-section="all">
                    ?? All Files
                </div>
                <div class="sidebar-item" data-section="images">
                    ??? Images
                </div>
                <div class="sidebar-item" data-section="documents">
                    ?? Documents
                </div>
                <div class="sidebar-item" data-section="videos">
                    ?? Videos
                </div>
                <div class="sidebar-item" data-section="recent">
                    ?? Recent
                </div>
                <div class="sidebar-item" data-section="favorites">
                    ? Favorites
                </div>
                <div class="sidebar-item" data-section="trash">
                    ??? Trash
                </div>
            </aside>

            <main class="content-area">
                <!-- Breadcrumb -->
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item" onclick="navigateToFolder(null)">?? Home</span>
                </div>

                <!-- Bulk Actions -->
                <div class="bulk-actions hidden" id="bulkActions">
                    <span id="selectionCount">0 files selected</span>
                    <button class="btn" onclick="bulkDownload()">?? Download</button>
                    <button class="btn" onclick="bulkDelete()">??? Delete</button>
                    <button class="btn" onclick="bulkMove()">?? Move</button>
                    <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                </div>

                <div class="toolbar">
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        ?? Upload Files
                    </button>
                    <button class="btn" onclick="createFolder()">
                        ?? New Folder
                    </button>
                    <button class="btn" onclick="toggleView()">
                        ? Grid View
                    </button>
                    <button class="btn btn-secondary" onclick="backupData()">
                        ?? Backup
                    </button>
                    <button class="btn btn-secondary" onclick="restoreData()">
                        ?? Restore
                    </button>
                </div>

                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">??</div>
                    <h3>Drag & Drop files here or click to upload</h3>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                        Support for all file types - Images, Documents, Videos, and more
                    </p>
                    <div class="progress-bar hidden" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="files-grid" id="filesGrid">
                    <!-- Files will be populated here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" multiple style="display: none;">

    <!-- Status indicator -->
    <div class="status-indicator" id="statusIndicator">
        File uploaded successfully!
    </div>

    <!-- Modal for file preview/actions -->
    <div class="modal" id="fileModal">
        <div class="modal-content" id="modalContent">
            <h3 id="modalTitle">File Details</h3>
            <div id="modalBody"></div>
            <div style="margin-top: 2rem; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3>?? Settings</h3>
            <div class="settings-section">
                <h3>Security</h3>
                <div class="setting-item">
                    <div>
                        <strong>Change Password</strong>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Update your login password</p>
                    </div>
                    <button class="btn" onclick="changePassword()">Change</button>
                </div>
            </div>
            <div class="settings-section">
                <h3>Storage</h3>
                <div class="setting-item">
                    <div>
                        <strong>Storage Limit</strong>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Set maximum storage capacity (in GB)</p>
                    </div>
                    <div class="storage-setting">
                        <input type="number" id="storageLimitInput" min="1" max="10000" placeholder="1000">
                        <span>GB</span>
                        <button class="btn" onclick="updateStorageLimit()">Update</button>
                    </div>
                </div>
                <div class="setting-item">
                    <div>
                        <strong>Clear Cache</strong>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Remove temporary files and cache</p>
                    </div>
                    <button class="btn btn-secondary" onclick="clearCache()">Clear</button>
                </div>
                <div class="setting-item">
                    <div>
                        <strong>Export All Data</strong>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Download all your files as a backup</p>
                    </div>
                    <button class="btn" onclick="exportAllData()">Export</button>
                </div>
            </div>
            <div class="settings-section">
                <h3>Display</h3>
                <div class="setting-item">
                    <div>
                        <strong>Auto Dark Mode</strong>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Automatically switch theme based on time</p>
                    </div>
                    <input type="checkbox" id="autoDarkMode" onchange="toggleAutoDarkMode()">
                </div>
            </div>
            <div style="margin-top: 2rem; text-align: right;">
                <button class="btn btn-secondary" onclick="closeSettings()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let files = [];
        let currentSection = 'all';
        let currentFolder = null;
        let selectedFiles = new Set();
        let isLoggedIn = false;
        let userPassword = '0122333';
        let maxStorageGB = 1000; // Default 1TB in GB

        // Initialize app data
        function initializeApp() {
            // Try to load data from localStorage first, then fall back to in-memory
            try {
                const savedFiles = localStorage.getItem('cloudvault_files');
                if (savedFiles) {
                    files = JSON.parse(savedFiles);
                }
                
                const savedPassword = localStorage.getItem('cloudvault_password');
                if (savedPassword) {
                    userPassword = savedPassword;
                }
                
                const savedStorage = localStorage.getItem('cloudvault_storage_limit');
                if (savedStorage) {
                    maxStorageGB = parseInt(savedStorage);
                }
            } catch (error) {
                console.warn('localStorage not available, using memory storage:', error);
                // Keep default values when localStorage fails
            }
        }

        // File type icons
        const fileIcons = {
            'image': '???',
            'video': '??',
            'audio': '??',
            'pdf': '??',
            'doc': '??',
            'txt': '??',
            'zip': '??',
            'folder': '??',
            'html': '??',
            'css': '??',
            'js': '?',
            'json': '??',
            'default': '??'
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            updateStorageInfo();
            loadSettings();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // File input
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);

            // Drag and drop
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);

            // Sidebar navigation
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelector('.sidebar-item.active')?.classList.remove('active');
                    this.classList.add('active');
                    currentSection = this.dataset.section;
                    currentFolder = null;
                    updateBreadcrumb();
                    renderFiles();
                });
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', handleSearch);

            // Click outside modal to close
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeModal();
                    closeSettings();
                }
            });
        }

        function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            
            if (password === userPassword) {
                isLoggedIn = true;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                showStatus('Welcome to CloudVault Pro!', 'success');
                renderFiles();
            } else {
                showStatus('Incorrect password!', 'error');
                document.getElementById('password').style.borderColor = 'var(--error)';
                setTimeout(() => {
                    document.getElementById('password').style.borderColor = 'var(--border)';
                }, 2000);
            }
        }

        function logout() {
            isLoggedIn = false;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('password').value = '';
            selectedFiles.clear();
            currentFolder = null;
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', newTheme);
            document.getElementById('themeToggle').textContent = newTheme === 'light' ? '??' : '??';
            
            saveToStorage('theme', newTheme);
            showStatus(`Switched to ${newTheme} mode`, 'success');
        }

        function handleFileUpload(e) {
            const selectedFiles = Array.from(e.target.files);
            uploadFiles(selectedFiles);
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.add('dragover');
        }

        function handleDragLeave() {
            document.getElementById('uploadArea').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
            const droppedFiles = Array.from(e.dataTransfer.files);
            uploadFiles(droppedFiles);
        }

        function uploadFiles(fileList) {
            const validFiles = fileList.filter(validateFile);
            if (validFiles.length === 0) return;

            // Check storage limit
            const currentSize = files.reduce((sum, file) => sum + (file.size || 0), 0);
            const newFilesSize = validFiles.reduce((sum, file) => sum + file.size, 0);
            const maxStorage = maxStorageGB * 1024 * 1024 * 1024; // Convert GB to bytes
            
            if (currentSize + newFilesSize > maxStorage) {
                showStatus('Not enough storage space!', 'error');
                return;
            }

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.classList.remove('hidden');
            let uploaded = 0;
            const total = validFiles.length;

            validFiles.forEach((file, index) => {
                setTimeout(() => {
                    const fileData = {
                        id: Date.now() + index,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadDate: new Date().toISOString(),
                        isFavorite: false,
                        parentFolder: currentFolder,
                        tags: []
                    };

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        fileData.dataUrl = e.target.result;
                        
                        // Extract text content for text files
                        if (file.type.startsWith('text/') || file.name.endsWith('.html') || file.name.endsWith('.css') || file.name.endsWith('.js') || file.name.endsWith('.json')) {
                            try {
                                fileData.textContent = e.target.result.split(',')[1] ? 
                                    atob(e.target.result.split(',')[1]) : '';
                            } catch (err) {
                                console.error('Error extracting text content:', err);
                            }
                        }

                        files.push(fileData);
                        saveFiles();
                        
                        uploaded++;
                        const progress = (uploaded / total) * 100;
                        progressFill.style.width = progress + '%';
                        
                        if (uploaded === total) {
                            setTimeout(() => {
                                progressBar.classList.add('hidden');
                                progressFill.style.width = '0%';
                                renderFiles();
                                updateStorageInfo();
                                showStatus(`${total} file(s) uploaded successfully!`, 'success');
                            }, 500);
                        }
                    };
                    reader.readAsDataURL(file);
                }, index * 100);
            });
        }

        function validateFile(file) {
            const maxSize = 5 * 1024 * 1024 * 1024; // 5GB per file
            
            if (file.size > maxSize) {
                showStatus(`File ${file.name} is too large (max 5GB per file)`, 'error');
                return false;
            }

            return true;
        }

        function getFileIcon(file) {
            if (file.isFolder) return fileIcons.folder;
            if (file.type && file.type.startsWith('image/')) return fileIcons.image;
            if (file.type && file.type.startsWith('video/')) return fileIcons.video;
            if (file.type && file.type.startsWith('audio/')) return fileIcons.audio;
            if (file.type === 'application/pdf') return fileIcons.pdf;
            if (file.type && (file.type.includes('document') || file.type.includes('word'))) return fileIcons.doc;
            if (file.name.endsWith('.html') || file.name.endsWith('.htm')) return fileIcons.html;
            if (file.name.endsWith('.css')) return fileIcons.css;
            if (file.name.endsWith('.js')) return fileIcons.js;
            if (file.name.endsWith('.json')) return fileIcons.json;
            if (file.type === 'text/plain') return fileIcons.txt;
            if (file.type && (file.type.includes('zip') || file.type.includes('compressed'))) return fileIcons.zip;
            return fileIcons.default;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function renderFiles() {
            const grid = document.getElementById('filesGrid');
            let filteredFiles = files.filter(file => 
                !file.isDeleted && file.parentFolder === currentFolder
            );

            // Filter by section
            if (currentSection === 'images') {
                filteredFiles = filteredFiles.filter(file => file.type && file.type.startsWith('image/'));
            } else if (currentSection === 'documents') {
                filteredFiles = filteredFiles.filter(file => 
                    file.type && (file.type.includes('document') || file.type.includes('pdf') || file.type.includes('text') || file.name.endsWith('.html'))
                );
            } else if (currentSection === 'videos') {
                filteredFiles = filteredFiles.filter(file => file.type && file.type.startsWith('video/'));
            } else if (currentSection === 'recent') {
                filteredFiles = files.filter(file => !file.isDeleted)
                    .sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate)).slice(0, 20);
            } else if (currentSection === 'favorites') {
                filteredFiles = files.filter(file => !file.isDeleted && file.isFavorite);
            } else if (currentSection === 'trash') {
                filteredFiles = files.filter(file => file.isDeleted);
            }

            grid.innerHTML = '';

            if (filteredFiles.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">??</div>
                        <h3>No files found</h3>
                        <p>Upload some files to get started!</p>
                    </div>
                `;
                return;
            }

            filteredFiles.forEach(file => {
                const card = document.createElement('div');
                card.className = 'file-card';
                card.dataset.fileId = file.id;
                card.onclick = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        toggleFileSelection(file.id);
                        e.stopPropagation();
                    } else if (file.isFolder) {
                        navigateToFolder(file.id);
                    } else {
                        openFile(file);
                    }
                };
                
                if (selectedFiles.has(file.id)) {
                    card.classList.add('selected');
                }
                
                card.innerHTML = `
                    <div class="file-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); toggleFavorite(${file.id})" title="Toggle favorite">
                            ${file.isFavorite ? '?' : '?'}
                        </button>
                        ${!file.isFolder ? `
                        <button class="action-btn" onclick="event.stopPropagation(); downloadFile(${file.id})" title="Download">
                            ??
                        </button>
                        ` : ''}
                        <button class="action-btn" onclick="event.stopPropagation(); deleteFile(${file.id})" title="Delete">
                            ???
                        </button>
                    </div>
                    <div class="file-icon ${file.isFolder ? 'folder-icon' : ''}">${getFileIcon(file)}</div>
                    <div class="file-name">${escapeHtml(file.name)}</div>
                    <div class="file-size">${file.isFolder ? getFolderSize(file.id) : formatFileSize(file.size)}</div>
                `;
                
                grid.appendChild(card);
            });

            updateBulkActions();
        }

        function getFolderSize(folderId) {
            const folderFiles = files.filter(f => f.parentFolder === folderId && !f.isDeleted);
            const count = folderFiles.length;
            const totalSize = folderFiles.reduce((sum, file) => sum + (file.size || 0), 0);
            return `${count} items (${formatFileSize(totalSize)})`;
        }

        function navigateToFolder(folderId) {
            currentFolder = folderId;
            updateBreadcrumb();
            renderFiles();
        }

        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            let path = ['<span class="breadcrumb-item" onclick="navigateToFolder(null)">?? Home</span>'];
            
            if (currentFolder) {
                const folder = files.find(f => f.id === currentFolder);
                if (folder) {
                    path.push('<span>›</span>');
                    path.push(`<span class="breadcrumb-item">${escapeHtml(folder.name)}</span>`);
                }
            }
            
            breadcrumb.innerHTML = path.join(' ');
        }

        function openFile(file) {
            const modal = document.getElementById('fileModal');
            const modalContent = document.getElementById('modalContent');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = file.name;
            
            let contentHtml = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: var(--surface); border-radius: 0.5rem;">
                    <p><strong>Size:</strong> ${formatFileSize(file.size)}</p>
                    <p><strong>Type:</strong> ${file.type || 'Unknown'}</p>
                    <p><strong>Upload Date:</strong> ${new Date(file.uploadDate).toLocaleDateString()}</p>
                </div>
            `;
            
            if (file.type && file.type.startsWith('image/')) {
                // Image preview
                modalContent.classList.add('modal-large');
                contentHtml += `
                    <div class="image-viewer">
                        <img src="${file.dataUrl}" alt="${escapeHtml(file.name)}" onclick="openFullscreen('${file.dataUrl}', 'image')">
                        <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn" onclick="openFullscreen('${file.dataUrl}', 'image')">?? Fullscreen</button>
                            <button class="btn" onclick="downloadFile(${file.id})">?? Download</button>
                        </div>
                    </div>
                `;
                
            } else if (file.type && file.type.startsWith('video/')) {
                // Video player
                modalContent.classList.add('modal-large');
                contentHtml += `
                    <div style="text-align: center;">
                        <video src="${file.dataUrl}" controls style="max-width: 100%; max-height: 60vh; border-radius: 0.5rem;">
                            Your browser does not support video playback.
                        </video>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn" onclick="downloadFile(${file.id})">?? Download</button>
                        </div>
                    </div>
                `;
                
            } else if (file.type && file.type.startsWith('audio/')) {
                // Audio player
                contentHtml += `
                    <div style="text-align: center; padding: 2rem; background: var(--surface); border-radius: 0.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">??</div>
                        <audio src="${file.dataUrl}" controls style="width: 100%;" preload="metadata">
                            Your browser does not support audio playback.
                        </audio>
                        <div style="margin-top: 1rem;">
                            <button class="btn" onclick="downloadFile(${file.id})">?? Download</button>
                        </div>
                    </div>
                `;
                
            } else if (file.type === 'application/pdf') {
                // PDF viewer
                modalContent.classList.add('modal-large');
                contentHtml += `
                    <div style="text-align: center;">
                        <iframe src="${file.dataUrl}" class="pdf-viewer">
                            Your browser does not support PDF viewing.
                        </iframe>
                        <div style="margin-top: 1rem;">
                            <button class="btn" onclick="openInNewTab('${file.dataUrl}')">?? Open in New Tab</button>
                            <button class="btn" onclick="downloadFile(${file.id})">?? Download</button>
                        </div>
                    </div>
                `;
                
            } else if (isCodeFile(file) && file.textContent) {
                // Code file viewer
                modalContent.classList.add('modal-large');
                const codeContent = file.textContent || '';
                const language = getCodeLanguage(file.name);
                contentHtml += `
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                            <span style="font-weight: 500;">?? ${language.toUpperCase()} Code</span>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-secondary" onclick="copyToClipboard('${escapeForJs(codeContent)}')">?? Copy</button>
                                <button class="btn" onclick="editCodeFile('${file.id}')">?? Edit</button>
                            </div>
                        </div>
                        <pre style="background: var(--background); padding: 1rem; border-radius: 0.5rem; overflow: auto; max-height: 500px; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.4; border: 1px solid var(--border);"><code>${escapeHtml(codeContent)}</code></pre>
                    </div>
                `;
                
            } else if ((file.type === 'text/plain' || (file.type && file.type.startsWith('text/'))) && file.textContent) {
                // Text file viewer
                const textContent = file.textContent || '';
                contentHtml += `
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                            <span style="font-weight: 500;">?? Text Content</span>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-secondary" onclick="copyToClipboard('${escapeForJs(textContent)}')">?? Copy</button>
                                <button class="btn" onclick="editTextFile('${file.id}')">?? Edit</button>
                            </div>
                        </div>
                        <pre style="background: var(--surface); padding: 1rem; border-radius: 0.5rem; overflow: auto; max-height: 400px; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.4; border: 1px solid var(--border);">${escapeHtml(textContent)}</pre>
                    </div>
                `;
                
            } else {
                // Generic file
                contentHtml += `
                    <div style="text-align: center; padding: 2rem; background: var(--surface); border-radius: 0.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">${getFileIcon(file)}</div>
                        <p>File preview not available</p>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem;">This file type cannot be previewed in the browser</p>
                        <div style="margin-top: 1rem;">
                            <button class="btn" onclick="downloadFile(${file.id})">?? Download File</button>
                        </div>
                    </div>
                `;
            }
            
            body.innerHTML = contentHtml;
            modal.classList.add('show');
        }

        function closeModal() {
            const modal = document.getElementById('fileModal');
            const modalContent = document.getElementById('modalContent');
            modal.classList.remove('show');
            modalContent.classList.remove('modal-large');
        }

        // File action functions
        function toggleFavorite(fileId) {
            const file = files.find(f => f.id === fileId);
            if (file) {
                file.isFavorite = !file.isFavorite;
                saveFiles();
                renderFiles();
                showStatus(`${file.isFavorite ? 'Added to' : 'Removed from'} favorites`, 'success');
            }
        }

        function downloadFile(fileId) {
            const file = files.find(f => f.id === fileId);
            if (file && file.dataUrl) {
                const a = document.createElement('a');
                a.href = file.dataUrl;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showStatus('Download started', 'success');
            }
        }

        function deleteFile(fileId) {
            const file = files.find(f => f.id === fileId);
            if (file) {
                if (currentSection === 'trash') {
                    // Permanently delete
                    files = files.filter(f => f.id !== fileId);
                    showStatus('File permanently deleted', 'success');
                } else {
                    // Move to trash
                    file.isDeleted = true;
                    showStatus('File moved to trash', 'success');
                }
                saveFiles();
                renderFiles();
                updateStorageInfo();
            }
        }

        // File editing functions
        function editCodeFile(fileId) {
            const file = files.find(f => f.id == fileId);
            if (!file) return;
            
            const codeContent = file.textContent || '';
            
            const modal = document.getElementById('fileModal');
            const modalContent = document.getElementById('modalContent');
            const body = document.getElementById('modalBody');
            
            modalContent.classList.add('modal-large');
            body.innerHTML = `
                <div>
                    <h4>Edit Code File: ${escapeHtml(file.name)}</h4>
                    <textarea class="code-editor" id="codeEditor" placeholder="Enter code...">${escapeHtml(codeContent)}</textarea>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="openFile(files.find(f => f.id === ${fileId}))">Cancel</button>
                        <button class="btn" onclick="saveCodeFile('${fileId}')">?? Save</button>
                    </div>
                </div>
            `;
        }

        function saveCodeFile(fileId) {
            const file = files.find(f => f.id == fileId);
            if (!file) return;
            
            const newContent = document.getElementById('codeEditor').value;
            
            file.textContent = newContent;
            const mimeType = file.type || 'text/plain';
            file.dataUrl = 'data:' + mimeType + ';base64,' + btoa(unescape(encodeURIComponent(newContent)));
            
            saveFiles();
            showStatus('Code file saved successfully!', 'success');
            openFile(file);
        }

        function editTextFile(fileId) {
            const file = files.find(f => f.id == fileId);
            if (!file) return;
            
            const textContent = file.textContent || '';
            
            const modal = document.getElementById('fileModal');
            const modalContent = document.getElementById('modalContent');
            const body = document.getElementById('modalBody');
            
            modalContent.classList.add('modal-large');
            body.innerHTML = `
                <div>
                    <h4>Edit Text File: ${escapeHtml(file.name)}</h4>
                    <textarea class="code-editor" id="textEditor" placeholder="Enter text...">${escapeHtml(textContent)}</textarea>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="openFile(files.find(f => f.id === ${fileId}))">Cancel</button>
                        <button class="btn" onclick="saveTextFile('${fileId}')">?? Save</button>
                    </div>
                </div>
            `;
        }

        function saveTextFile(fileId) {
            const file = files.find(f => f.id == fileId);
            if (!file) return;
            
            const newContent = document.getElementById('textEditor').value;
            
            file.textContent = newContent;
            file.dataUrl = 'data:text/plain;base64,' + btoa(unescape(encodeURIComponent(newContent)));
            
            saveFiles();
            showStatus('Text file saved successfully!', 'success');
            openFile(file);
        }

        function openInNewTab(url) {
            window.open(url, '_blank');
        }

        function openFullscreen(src, type) {
            const fullscreenDiv = document.createElement('div');
            fullscreenDiv.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); z-index: 2000; display: flex; 
                align-items: center; justify-content: center; cursor: pointer;
            `;
            
            let content;
            if (type === 'image') {
                content = `<img src="${src}" style="max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 0.5rem;">`;
            } else if (type === 'video') {
                content = `<video src="${src}" controls autoplay style="max-width: 95%; max-height: 95%; border-radius: 0.5rem;">`;
            }
            
            fullscreenDiv.innerHTML = content + '<div style="position: absolute; top: 20px; right: 30px; color: white; font-size: 2rem; cursor: pointer; user-select: none;">?</div>';
            
            fullscreenDiv.onclick = (e) => {
                if (e.target === fullscreenDiv || e.target.textContent === '?') {
                    document.body.removeChild(fullscreenDiv);
                }
            };
            document.body.appendChild(fullscreenDiv);
        }

        // Folder functions
        function createFolder() {
            const name = prompt('Enter folder name:');
            if (name && name.trim()) {
                const folder = {
                    id: Date.now(),
                    name: name.trim(),
                    type: 'folder',
                    size: 0,
                    uploadDate: new Date().toISOString(),
                    isFavorite: false,
                    isFolder: true,
                    parentFolder: currentFolder
                };
                files.push(folder);
                saveFiles();
                renderFiles();
                showStatus('Folder created successfully', 'success');
            }
        }

        // Search function
        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            
            if (!query.trim()) {
                renderFiles();
                return;
            }

            const searchResults = files.filter(file => 
                !file.isDeleted && 
                (file.name.toLowerCase().includes(query) || 
                 (file.type && file.type.toLowerCase().includes(query)))
            );

            renderSearchResults(searchResults, query);
        }

        function renderSearchResults(results, query) {
            const grid = document.getElementById('filesGrid');
            grid.innerHTML = '';

            if (results.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">??</div>
                        <h3>No files found for "${escapeHtml(query)}"</h3>
                        <p>Try adjusting your search terms</p>
                    </div>
                `;
                return;
            }

            results.forEach(file => {
                const card = document.createElement('div');
                card.className = 'file-card';
                card.onclick = () => {
                    if (file.isFolder) {
                        navigateToFolder(file.id);
                    } else {
                        openFile(file);
                    }
                };
                
                card.innerHTML = `
                    <div class="file-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); toggleFavorite(${file.id})" title="Toggle favorite">
                            ${file.isFavorite ? '?' : '?'}
                        </button>
                        ${!file.isFolder ? `
                        <button class="action-btn" onclick="event.stopPropagation(); downloadFile(${file.id})" title="Download">
                            ??
                        </button>
                        ` : ''}
                        <button class="action-btn" onclick="event.stopPropagation(); deleteFile(${file.id})" title="Delete">
                            ???
                        </button>
                    </div>
                    <div class="file-icon ${file.isFolder ? 'folder-icon' : ''}">${getFileIcon(file)}</div>
                    <div class="file-name">${highlightMatch(escapeHtml(file.name), escapeHtml(query))}</div>
                    <div class="file-size">${file.isFolder ? getFolderSize(file.id) : formatFileSize(file.size)}</div>
                `;
                
                grid.appendChild(card);
            });
        }

        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark style="background: var(--primary-color); color: white; padding: 0.1rem 0.2rem; border-radius: 0.2rem;">$1</mark>');
        }

        // Selection functions
        function toggleFileSelection(fileId) {
            if (selectedFiles.has(fileId)) {
                selectedFiles.delete(fileId);
            } else {
                selectedFiles.add(fileId);
            }
            updateBulkActions();
            renderFiles();
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectionCount = document.getElementById('selectionCount');
            
            if (selectedFiles.size > 0) {
                bulkActions.classList.remove('hidden');
                selectionCount.textContent = `${selectedFiles.size} file${selectedFiles.size > 1 ? 's' : ''} selected`;
            } else {
                bulkActions.classList.add('hidden');
            }
        }

        function bulkDownload() {
            selectedFiles.forEach(fileId => downloadFile(fileId));
            showStatus(`Downloaded ${selectedFiles.size} files`, 'success');
            clearSelection();
        }

        function bulkDelete() {
            if (confirm(`Are you sure you want to delete ${selectedFiles.size} files?`)) {
                selectedFiles.forEach(fileId => deleteFile(fileId));
                showStatus(`Deleted ${selectedFiles.size} files`, 'success');
                clearSelection();
            }
        }

        function bulkMove() {
            const folders = files.filter(f => f.isFolder && !f.isDeleted);
            if (folders.length === 0) {
                showStatus('No folders available. Create a folder first.', 'warning');
                return;
            }

            const folderList = folders.map(f => f.name).join('\n');
            const targetFolder = prompt(`Move ${selectedFiles.size} files to folder:\n\n${folderList}\n\nEnter folder name:`);
            
            if (targetFolder) {
                const folder = folders.find(f => f.name === targetFolder);
                if (folder) {
                    selectedFiles.forEach(fileId => {
                        const file = files.find(f => f.id === fileId);
                        if (file) {
                            file.parentFolder = folder.id;
                        }
                    });
                    saveFiles();
                    showStatus(`Moved ${selectedFiles.size} files to ${targetFolder}`, 'success');
                    clearSelection();
                    renderFiles();
                } else {
                    showStatus('Folder not found', 'error');
                }
            }
        }

        function clearSelection() {
            selectedFiles.clear();
            updateBulkActions();
            renderFiles();
        }

        // Settings functions
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const autoDarkMode = document.getElementById('autoDarkMode');
            const storageLimitInput = document.getElementById('storageLimitInput');
            
            autoDarkMode.checked = getFromStorage('autoDarkMode') === 'true';
            storageLimitInput.value = maxStorageGB;
            
            modal.classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function changePassword() {
            const currentPassword = prompt('Enter current password:');
            if (currentPassword !== userPassword) {
                showStatus('Incorrect current password', 'error');
                return;
            }

            const newPassword = prompt('Enter new password:');
            if (newPassword && newPassword.length >= 6) {
                const confirmPassword = prompt('Confirm new password:');
                if (newPassword === confirmPassword) {
                    userPassword = newPassword;
                    saveToStorage('cloudvault_password', newPassword);
                    showStatus('Password changed successfully', 'success');
                } else {
                    showStatus('Passwords do not match', 'error');
                }
            } else {
                showStatus('Password must be at least 6 characters', 'error');
            }
        }

        function updateStorageLimit() {
            const input = document.getElementById('storageLimitInput');
            const newLimit = parseInt(input.value);
            
            if (newLimit && newLimit > 0 && newLimit <= 10000) {
                maxStorageGB = newLimit;
                saveToStorage('cloudvault_storage_limit', newLimit.toString());
                updateStorageInfo();
                showStatus(`Storage limit updated to ${newLimit} GB`, 'success');
            } else {
                showStatus('Please enter a valid storage limit (1-10000 GB)', 'error');
            }
        }

        function clearCache() {
            if (confirm('This will clear all temporary data. Continue?')) {
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
                showStatus('Cache cleared successfully', 'success');
            }
        }

        function exportAllData() {
            const exportData = {
                files: files,
                settings: {
                    theme: getFromStorage('theme'),
                    autoDarkMode: getFromStorage('autoDarkMode'),
                    storageLimit: maxStorageGB,
                    password: userPassword
                },
                timestamp: new Date().toISOString(),
                version: '2.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `cloudvault-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('Data exported successfully', 'success');
        }

        function toggleAutoDarkMode() {
            const enabled = document.getElementById('autoDarkMode').checked;
            saveToStorage('autoDarkMode', enabled.toString());
            
            if (enabled) {
                checkAutoTheme();
                showStatus('Auto dark mode enabled', 'success');
            } else {
                showStatus('Auto dark mode disabled', 'success');
            }
        }

        function checkAutoTheme() {
            const hour = new Date().getHours();
            const autoDarkMode = getFromStorage('autoDarkMode') === 'true';
            
            if (autoDarkMode) {
                const shouldBeDark = hour < 6 || hour >= 18;
                const currentTheme = document.body.getAttribute('data-theme');
                
                if (shouldBeDark && currentTheme === 'light') {
                    document.body.setAttribute('data-theme', 'dark');
                    document.getElementById('themeToggle').textContent = '??';
                    saveToStorage('theme', 'dark');
                } else if (!shouldBeDark && currentTheme === 'dark') {
                    document.body.setAttribute('data-theme', 'light');
                    document.getElementById('themeToggle').textContent = '??';
                    saveToStorage('theme', 'light');
                }
            }
        }

        // View toggle function
        function toggleView() {
            const grid = document.getElementById('filesGrid');
            const btn = event.target;
            
            if (grid.style.display === 'flex') {
                grid.style.display = 'grid';
                grid.style.flexDirection = '';
                btn.textContent = '? Grid View';
            } else {
                grid.style.display = 'flex';
                grid.style.flexDirection = 'column';
                btn.textContent = '? List View';
            }
        }

        // Backup and restore functions
        function backupData() {
            const backup = {
                files: files,
                settings: {
                    theme: getFromStorage('theme'),
                    autoDarkMode: getFromStorage('autoDarkMode'),
                    storageLimit: maxStorageGB,
                    password: userPassword
                },
                timestamp: new Date().toISOString(),
                version: '2.0'
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `cloudvault-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('Backup created successfully', 'success');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (backup.files && Array.isArray(backup.files)) {
                            if (confirm('This will replace all current data. Continue?')) {
                                files = backup.files;
                                
                                // Restore settings if available
                                if (backup.settings) {
                                    if (backup.settings.theme) {
                                        saveToStorage('theme', backup.settings.theme);
                                        document.body.setAttribute('data-theme', backup.settings.theme);
                                        document.getElementById('themeToggle').textContent = 
                                            backup.settings.theme === 'light' ? '??' : '??';
                                    }
                                    if (backup.settings.autoDarkMode) {
                                        saveToStorage('autoDarkMode', backup.settings.autoDarkMode);
                                    }
                                    if (backup.settings.storageLimit) {
                                        maxStorageGB = backup.settings.storageLimit;
                                        saveToStorage('cloudvault_storage_limit', maxStorageGB.toString());
                                    }
                                    if (backup.settings.password) {
                                        userPassword = backup.settings.password;
                                        saveToStorage('cloudvault_password', userPassword);
                                    }
                                }
                                
                                saveFiles();
                                renderFiles();
                                updateStorageInfo();
                                showStatus('Data restored successfully', 'success');
                            }
                        } else {
                            showStatus('Invalid backup file format', 'error');
                        }
                    } catch (error) {
                        showStatus('Error reading backup file', 'error');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Utility functions for storage
        function saveToStorage(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (error) {
                console.warn(`Could not save ${key} to localStorage:`, error);
                // Store in memory as fallback
                window[`_cloudvault_${key}`] = value;
            }
        }

        function getFromStorage(key) {
            try {
                return localStorage.getItem(key) || window[`_cloudvault_${key}`] || null;
            } catch (error) {
                console.warn(`Could not get ${key} from localStorage:`, error);
                return window[`_cloudvault_${key}`] || null;
            }
        }

        function saveFiles() {
            try {
                localStorage.setItem('cloudvault_files', JSON.stringify(files));
            } catch (error) {
                console.warn('Could not save files to localStorage:', error);
                // Keep files in memory
                window._cloudvault_files = files;
                showStatus('Warning: Changes saved in memory only', 'warning');
            }
        }

        function updateStorageInfo() {
            const totalSize = files.reduce((sum, file) => sum + (file.size || 0), 0);
            const maxStorage = maxStorageGB * 1024 * 1024 * 1024; // Convert GB to bytes
            
            let displaySize, unit;
            if (totalSize < 1024 * 1024) {
                displaySize = (totalSize / 1024).toFixed(1);
                unit = 'KB';
            } else if (totalSize < 1024 * 1024 * 1024) {
                displaySize = (totalSize / (1024 * 1024)).toFixed(1);
                unit = 'MB';
            } else {
                displaySize = (totalSize / (1024 * 1024 * 1024)).toFixed(1);
                unit = 'GB';
            }
            
            const usagePercent = ((totalSize / maxStorage) * 100).toFixed(1);
            
            // Update display
            document.getElementById('usedStorage').textContent = `${displaySize} ${unit}`;
            document.getElementById('maxStorage').textContent = `${maxStorageGB} GB`;
            document.getElementById('totalStorage').textContent = maxStorageGB >= 1000 ? `${(maxStorageGB/1000).toFixed(1)} TB` : `${maxStorageGB} GB`;
            
            // Add storage warning if over 80%
            const storageInfo = document.getElementById('storageInfo');
            if (usagePercent > 80) {
                storageInfo.style.color = 'var(--warning)';
                if (usagePercent > 95) {
                    storageInfo.style.color = 'var(--error)';
                }
            } else {
                storageInfo.style.color = 'var(--text-secondary)';
            }
        }

        function showStatus(message, type = 'success') {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            indicator.className = `status-indicator show`;
            
            if (type === 'error') {
                indicator.style.background = 'var(--error)';
            } else if (type === 'warning') {
                indicator.style.background = 'var(--warning)';
            } else {
                indicator.style.background = 'var(--success)';
            }
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        function loadSettings() {
            // Load saved theme
            const savedTheme = getFromStorage('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('themeToggle').textContent = savedTheme === 'light' ? '??' : '??';
            
            // Check auto dark mode
            checkAutoTheme();
        }

        // Helper functions for code files
        function isCodeFile(file) {
            const codeExtensions = ['.js', '.html', '.htm', '.css', '.py', '.java', '.cpp', '.c', '.php', '.rb', '.go', '.rs', '.ts', '.jsx', '.tsx', '.vue', '.svelte', '.xml', '.sql', '.sh', '.bat', '.ps1', '.yaml', '.yml', '.json', '.md'];
            return codeExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
        }

        function getCodeLanguage(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const languageMap = {
                'js': 'javascript', 'jsx': 'javascript', 'ts': 'typescript', 'tsx': 'typescript',
                'py': 'python', 'java': 'java', 'cpp': 'cpp', 'c': 'c', 'php': 'php',
                'rb': 'ruby', 'go': 'go', 'rs': 'rust', 'html': 'html', 'htm': 'html',
                'css': 'css', 'xml': 'xml', 'sql': 'sql', 'sh': 'bash', 'bat': 'batch',
                'ps1': 'powershell', 'yaml': 'yaml', 'yml': 'yaml', 'json': 'json',
                'md': 'markdown', 'vue': 'vue', 'svelte': 'svelte'
            };
            return languageMap[ext] || 'text';
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeForJs(text) {
            if (typeof text !== 'string') return '';
            return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showStatus('Copied to clipboard!', 'success');
                }).catch(() => {
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.position = 'fixed';
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showStatus('Copied to clipboard!', 'success');
                } else {
                    showStatus('Failed to copy to clipboard', 'error');
                }
            } catch (err) {
                showStatus('Failed to copy to clipboard', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+U for upload
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                closeModal();
                closeSettings();
            }
            
            // Ctrl+A to select all files
            if (e.ctrlKey && e.key === 'a' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                const visibleFiles = files.filter(f => 
                    !f.isDeleted && f.parentFolder === currentFolder
                );
                visibleFiles.forEach(file => selectedFiles.add(file.id));
                updateBulkActions();
                renderFiles();
            }
            
            // Delete key to delete selected files
            if (e.key === 'Delete' && selectedFiles.size > 0) {
                bulkDelete();
            }
        });

        // Auto-save functionality
        setInterval(saveFiles, 30000); // Auto-save every 30 seconds

        // Check for auto theme every hour
        setInterval(checkAutoTheme, 3600000);

        // Mobile responsive sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // Add mobile menu button for small screens
        if (window.innerWidth <= 640) {
            const headerLeft = document.querySelector('.header-left');
            const menuBtn = document.createElement('button');
            menuBtn.innerHTML = '?';
            menuBtn.className = 'theme-toggle';
            menuBtn.onclick = toggleSidebar;
            menuBtn.title = 'Toggle menu';
            headerLeft.insertBefore(menuBtn, headerLeft.firstChild);
        }

        // Context menu prevention on file cards
        document.addEventListener('contextmenu', function(e) {
            if (e.target.closest('.file-card')) {
                e.preventDefault();
                const fileCard = e.target.closest('.file-card');
                const fileId = parseInt(fileCard.dataset.fileId);
                if (fileId) {
                    toggleFileSelection(fileId);
                }
            }
        });

        // Initialize the app
        updateBreadcrumb();
    </script>
</body>
</html>